<ocx-portal-page permission="MENU#VIEW" helpArticleId="PAGE_MENU_DETAIL" pageName="PAGE_MENU_DETAIL">
  <ocx-page-header
    *ngIf="workspace"
    [header]="workspaceName ? workspaceName + ': ' + ('DIALOG.MENU.LABEL' | translate) : ''"
    [subheader]="'DIALOG.MENU.SUBHEADER' | translate"
    [actions]="(actions$ | async) ?? []"
  >
  </ocx-page-header>

  <ocx-page-content>
    <!-- on loading and preparing data -->
    <div *ngIf="loading" class="card flex flex-wrap justify-content-start align-items-center">
      <p-message
        severity="info"
        styleClass="p-2"
        icon="pi pi-spin pi-spinner"
        [text]="'ACTIONS.LOADING' | translate"
      ></p-message>
    </div>
    <!-- no menu defined -->
    <div
      *ngIf="menuNodes.length === 0 && !loading"
      class="px-3 card flex flex-wrap justify-content-between align-items-center"
    >
      <p-message severity="info" styleClass="p-2" [text]="'DIALOG.MENU.MENU_NOT_EXIST' | translate"></p-message>
      <button
        pButton
        icon="pi pi-plus"
        (click)="onCreateMenu($event)"
        label="{{ 'ACTIONS.CREATE.MENU' | translate }}"
      ></button>
    </div>

    <!-- menu exist -->
    <p-treeTable
      *ngIf="menuNodes.length > 0"
      #menuTree
      styleClass="px-2"
      id="workspace_menu_table"
      [columns]="(wRoles$ | async)?.stream ?? []"
      [value]="menuNodes"
      [globalFilterFields]="['name', 'url']"
      (onNodeCollapse)="onHierarchyViewChange($event)"
      (onNodeExpand)="onHierarchyViewChange($event)"
    >
      <ng-template pTemplate="caption" class="p-0">
        <div class="flex flex-wrap justify-content-between align-items-center gap-2">
          <div *ngIf="menuItems" class="flex flex-wrap gap-2">
            <p-button
              styleClass="h-full button-min-height"
              id="workspace_menu_table_header_expand_button"
              [title]="'ACTIONS.TREE.EXPAND_ALL.TOOLTIP' | translate"
              (onClick)="onExpandAll()"
              icon="pi pi-angle-double-down"
            ></p-button>
            <p-button
              styleClass="h-full button-min-height"
              id="workspace_menu_table_header_collapse_button"
              [title]="'ACTIONS.TREE.COLLAPSE_ALL.TOOLTIP' | translate"
              (onClick)="onCollapseAll()"
              icon="pi pi-angle-double-up"
            ></p-button>
            <p-button
              *ocxIfPermission="'MENU#DRAG_DROP'"
              id="workspace_menu_table_header_reorder"
              [label]="'DIALOG.MENU.HEADER.TREE_MODAL' | translate"
              [title]="'DIALOG.MENU.HEADER.TREE_MODAL.TOOLTIP' | translate"
              (onClick)="onDisplayTreeModal()"
              icon="pi pi-sort"
            ></p-button>
            <p-button
              *ngIf="!displayRoles"
              id="workspace_menu_table_header_roles"
              [label]="'DIALOG.MENU.HEADER.ROLES' | translate"
              [title]="'DIALOG.MENU.HEADER.ROLES.TOOLTIP' | translate"
              (onClick)="onDisplayRoles()"
              icon="pi pi-check-circle"
            ></p-button>
            <p-button
              *ngIf="displayRoles"
              id="workspace_menu_table_header_details"
              [label]="'DIALOG.MENU.TABS.DETAILS' | translate"
              [title]="'DIALOG.MENU.TABS.DETAILS.TOOLTIP' | translate"
              (onClick)="onDisplayRoles()"
              icon="pi pi-cog"
            ></p-button>
          </div>
          <div class="p-inputgroup w-13rem sm:w-17rem md:w-20rem">
            <span class="p-inputgroup-addon pi pi-filter"> </span>
            <span class="p-float-label">
              <input
                #menuTreeFilter
                pInputText
                type="text"
                class="py-0"
                id="workspace_menu_table_header_filter"
                (input)="menuTree.filterGlobal($any($event.target).value, 'contains')"
                [title]="'GENERAL.TOOLTIPS.FILTER' | translate"
              />
              <label for="workspace_menu_table_filter"> {{ 'GENERAL.FILTER_PLACEHOLDER' | translate }} </label>
            </span>
            <span
              id="workspace_menu_table_header_filter_clear"
              class="p-inputgroup-addon bg-primary cursor-pointer pi pi-filter-slash"
              (click)="onClearFilterMenuTable()"
              [title]="'GENERAL.TOOLTIPS.FILTER_CLEAR' | translate"
            >
            </span>
          </div>
          <p-button
            styleClass="h-full button-min-height"
            id="workspace_menu_table_reload_button"
            [title]="'GENERAL.TOOLTIPS.ACTION_RELOAD' | translate"
            (onClick)="onReload()"
            icon="pi pi-refresh"
          ></p-button>
        </div>
      </ng-template>

      <ng-template pTemplate="header" let-columns>
        <tr>
          <th id="workspace_menu_table_header_dummy" class="text-right border-transparent border-bottom-2"></th>
          <ng-container *ngIf="!displayRoles">
            <th id="workspace_menu_table_header_actions" class="text-center hidden-xs border-primary border-bottom-2">
              {{ 'ACTIONS.LABEL' | translate }}
            </th>
            <th
              id="workspace_menu_table_header_position"
              class="text-center hidden-md border-primary border-bottom-2"
              [title]="'DIALOG.MENU.TREE.POSITION.TOOLTIP' | translate"
            >
              Pos
            </th>
            <th
              id="workspace_menu_table_header_i18n"
              class="text-center hidden-md border-primary border-bottom-2"
              [title]="'DIALOG.MENU.TREE.I18N.TOOLTIP' | translate"
            >
              {{ 'DIALOG.MENU.TREE.I18N' | translate }}
            </th>
            <th
              id="workspace_menu_table_header_app"
              class="text-center hidden-md border-primary border-bottom-2"
              [title]="'DIALOG.MENU.TREE.PRODUCT.TOOLTIP' | translate"
            >
              PM
            </th>
            <th
              id="workspace_menu_table_header_url"
              class="hidden-sm border-primary border-bottom-2"
              [title]="'DIALOG.MENU.TREE.URL.TOOLTIP' | translate"
            >
              URL
            </th>
          </ng-container>

          <!-- ROLES (actually managed by IDM) -->
          <ng-container *ngIf="displayRoles">
            <th
              *ngFor="let role of columns"
              id="workspace_menu_table_header_roles"
              class="px-2 text-center border-primary border-bottom-2"
            >
              <div class="flex flex-column justify-content-between">
                <div [title]="role.description ? role.description : ''">
                  {{ role.name + (role.isWorkspaceRole ? ' (w)' : '') }}
                </div>
              </div>
            </th>
          </ng-container>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
        <tr [id]="'workspace_menu_table_row_' + rowData.key">
          <!-- menu item  [attr.colspan]="2" -->
          <td class="white-space-nowrap">
            <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
            <span *ngIf="rowData.badge" class="pi pi-{{ rowData.badge }} pr-2"></span>
            <span *ngIf="!rowData.badge" class="pi pi-folder pr-2 invisible"></span>
            <span [id]="'workspace_menu_table_row_' + rowData.key + '_name'">{{ rowData.name }}</span>
          </td>
          <!-- manage the item -->
          <ng-container *ngIf="!displayRoles">
            <td class="white-space-nowrap hidden-xs">
              <div class="flex gap-1">
                <!--button
                  pbutton
                  type="button"
                  [id]="'workspace_menu_table_row_' + rowData.key + '_disabled'"
                  (click)="onToggleDisable($event, rowData)"
                  [title]="'DIALOG.MENU.ACTION.DISABLED' | translate"
                  class="p-button-rounded p-button-text p-button p-component p-button-icon-only"
                >
                  <span
                    class="text-red-500 font-medium p-button-icon pi pi-check-circle"
                    [class.pi-check-circle]="!rowData['disabled']"
                    [class.pi-minus-circle]="rowData['disabled']"
                    [class.text-red-500]="rowData['disabled']"
                    [class.text-green-500]="!rowData['disabled']"
                    aria-hidden="true"
                  ></span>
                </button -->
                <button
                  pbutton
                  type="button"
                  [id]="'workspace_menu_table_row_' + rowData.key + '_goto_details'"
                  (click)="onGotoDetails($event, rowData)"
                  [title]="'DIALOG.MENU.ACTION.DETAILS' | translate"
                  class="p-button-rounded p-button-text p-button p-component p-button-icon-only"
                >
                  <span
                    class="text-primary font-medium p-button-icon pi pi-eye"
                    [class.pi-eye]="!myPermissions.includes('MENU#EDIT')"
                    [class.pi-pencil]="myPermissions.includes('MENU#EDIT')"
                    aria-hidden="true"
                  ></span>
                </button>
                <button
                  *ocxIfPermission="'MENU#EDIT'"
                  pbutton
                  type="button"
                  [id]="'workspace_menu_table_row_' + rowData.key + '_goto_new'"
                  (click)="onCreateMenu($event, rowData)"
                  [title]="'DIALOG.MENU.ACTION.NEW' | translate"
                  class="p-button-rounded p-button-text p-button p-component p-button-icon-only"
                >
                  <span class="text-primary font-medium p-button-icon pi pi-plus-circle" aria-hidden="true"></span>
                </button>
                <button
                  *ocxIfPermission="'MENU#DELETE'"
                  pbutton
                  type="button"
                  [id]="'workspace_menu_table_row_' + rowData.key + '_delete'"
                  (click)="onDeleteMenu($event, rowData)"
                  [title]="('DIALOG.MENU.ACTION.DELETE' | translate).replace('{{TYPE}}', 'Menu')"
                  class="p-button-rounded p-button-text p-button p-component p-button-icon-only"
                >
                  <span class="danger-action-text font-medium p-button-icon pi pi-trash" aria-hidden="true"></span>
                </button>
              </div>
            </td>
            <td [id]="'workspace_menu_table_row_' + rowData.key + '_position'" class="hidden-md">
              {{ rowData.positionPath }}
            </td>
            <td class="text-center hidden-md">
              <span
                *ngIf="isObjectEmpty(rowData.i18n)"
                [id]="'workspace_menu_table_row_' + rowData.key + '_i18n'"
                class="pi pi-check"
                [title]="'DIALOG.MENU.TREE.I18N.ROW.TOOLTIP' | translate"
              ></span>
            </td>
            <td class="text-center hidden-md">
              <span
                *ngIf="rowData.regMfeAligned"
                [id]="'workspace_menu_table_row_' + rowData.key + '_url'"
                class="pi pi-check"
              ></span>
            </td>
            <td class="hidden-sm">
              <a
                *ngIf="rowData.gotoUrl"
                [id]="'workspace_menu_table_row_' + rowData.key + '_url'"
                [href]="rowData.gotoUrl"
                (click)="($event.stopPropagation)"
                target="_blank"
                class="text-primary font-italic cursor-pointer pr-3"
                [title]="('ACTIONS.NAVIGATION.OPEN_IN_NEW_TAB' | translate) + ': ' + rowData.gotoUrl"
              >
                {{ limitText(rowData.url, 30) }}
              </a>
            </td>
          </ng-container>
          <!-- ASSIGNMENTS -->
          <ng-container *ngIf="displayRoles">
            <td
              *ngFor="let role of columns"
              class="text-center"
              [id]="'menu_detail_tree_table_data_' + role.name + '_' + rowData.key"
            >
              <span
                *ngIf="true"
                class="pi pi-circle-fill text-primary text-lg"
                [title]="'DIALOG.MENU.ASSIGNMENT.OK' | translate"
              >
              </span>
              <span
                *ngIf="false"
                class="pi pi-circle text-primary text-lg"
                [title]="'DIALOG.MENU.ASSIGNMENT.NOK' | translate"
              >
              </span></td
          ></ng-container>
        </tr>
      </ng-template>
    </p-treeTable>
  </ocx-page-content>
</ocx-portal-page>

<!--
  DETAIL + DELETE
-->
<app-menu-detail
  [workspaceName]="workspaceName"
  [menuItems]="menuItems"
  [menuItem]="menuItem"
  [parentItems]="parentItems"
  [changeMode]="changeMode"
  [displayDetailDialog]="displayMenuDetail"
  [displayDeleteDialog]="displayMenuDelete"
  (dataChanged)="onMenuItemChanged($event)"
></app-menu-detail>

<!-- IMPORT MENU -->
<p-dialog
  header="{{ 'DIALOG.MENU.HEADER.IMPORT' | translate }}"
  [(visible)]="displayMenuImport"
  [draggable]="true"
  [closable]="true"
  [modal]="true"
  (onHide)="onImportMenuHide()"
>
  <p-fileUpload
    mode="advanced"
    name="file"
    accept=".json"
    [maxFileSize]="1000000"
    [headers]="httpHeaders"
    [customUpload]="true"
    (onClear)="onImportMenuClear()"
    (onRemove)="onImportMenuClear()"
    (onSelect)="onImportMenuSelect($event)"
    (uploadHandler)="onImportMenuConfirmation()"
    [showUploadButton]="!menuImportError"
    [uploadLabel]="'ACTIONS.UPLOAD' | translate"
    [cancelLabel]="'ACTIONS.CANCEL' | translate"
    [chooseLabel]="'ACTIONS.CHOOSE' | translate"
    [uploadTitle]="'ACTIONS.UPLOAD' | translate"
  ></p-fileUpload>

  <p-message
    *ngIf="menuImportError"
    severity="error"
    styleClass="mt-3"
    text="{{ 'VALIDATION.ERRORS.PARSE_ERROR' | translate }}"
  ></p-message>

  <div class="flex justify-content-end gap-3 my-3">
    <button
      pButton
      type="button"
      icon="pi pi-times"
      id="workspace_import_button_close"
      [label]="'ACTIONS.NAVIGATION.CLOSE' | translate"
      [title]="'ACTIONS.NAVIGATION.CLOSE_WITHOUT_SAVE' | translate"
      (click)="onImportMenuHide()"
    ></button>
  </div>
</p-dialog>

<!-- TREE REORDER DIALOG -->
<p-dialog
  header="{{ 'DIALOG.MENU.HEADER.TREE_MODAL' | translate }}"
  [(visible)]="displayTreeModal"
  [draggable]="true"
  [closable]="true"
  [modal]="true"
  (onHide)="onHideTreeModal()"
  (onResizeInit)="onStartResizeTree($event)"
  (onResizeEnd)="onEndResizeTree($event)"
>
  <ul class="my-2">
    <li>{{ 'DIALOG.MENU.HEADER.REORDER.TOOLTIP' | translate }}</li>
    <li>{{ 'DIALOG.MENU.HEADER.PREVIEW.TOOLTIP' | translate }}</li>
    <li class="danger-action-text">{{ 'DIALOG.MENU.HEADER.PREVIEW2.TOOLTIP' | translate }}</li>
  </ul>
  <app-menu-tree
    *ngIf="menuItems"
    [selectedWorkspaceId]="workspaceName"
    [workspaceMenuItems]="menuItems"
    [updateTree]="displayTreeModal"
    [languagesPreview]="languagesPreview"
    (updateMenuStructureEmitter)="updateMenuItems($event)"
  >
  </app-menu-tree>
  <div class="flex justify-content-end my-3">
    <button
      pButton
      type="button"
      icon="pi pi-times"
      id="workspace_import_button_close"
      [label]="'ACTIONS.NAVIGATION.CLOSE' | translate"
      (click)="onHideTreeModal()"
    ></button>
  </div>
</p-dialog>
